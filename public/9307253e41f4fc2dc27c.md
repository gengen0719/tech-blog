---
title: 初めてのServerlessアプリ実装での 迷い&詰まり&学びポイント その１
tags:
  - AWS
  - 初心者
  - lambda
  - serverless
  - Lambda-Layers
private: false
updated_at: '2025-03-17T02:42:56+09:00'
id: 9307253e41f4fc2dc27c
organization_url_name: works-hi
slide: false
ignorePublish: false
---
# この記事について
Serverless初心者（WorkShopで触ったことはあるが、実際のアプリは作ったことがない人）がちょっとしたアプリの実装をやってみた際の迷い、詰まり、学びをつらつらと書きます。
Lambda多めかなと思って最初Lambdaのタイトルにしていましたが、Serverless全般の方が書きやすいなと思ったのでタイトルを変えました。

# 作っているもの
Googleカレンダーのその日の予定を確認し、お昼ご飯が食べられる時間をずんだもんが教えてくれるBot。
お昼ご飯が食べられないとかなしいのだ。

### 構成図（計画性低）

![ずんだもんBot.drawio (2).png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1126770/93d3d965-81d6-4e1f-b86e-35605a21b676.png)

とりあえずここまで実装してみました。

# 迷い&詰まり&学びポイント

## Lambda-Layersをどう構成するか？

https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/chapter-layers.html

Lambdaのランタイムはサイズを小さくするために必要最小限の構成になっています。
そのため必要なライブラリやパッケージは自分でLambda-Layersに配置する必要があります。

今回の実装ではPythonを利用しましたが、Pythonの場合はpipでインストールしたパッケージをzipに固めてLambda-Layersにアップロードし、関数に関連付けをする必要があります。
また実装の内容としてはGoogleCalendarから空き時間を取得して計算するため、GoogleのAPIを扱うライブラリやタイムゾーンを扱うパッケージが必要でした。

GoogleのAPIはともかくタイムゾーンにも必要だとほとんどの実装で配置することになりそうなので、zipに固めてアップするという手順はやや面倒に感じました。
また今回のような小さな実装では特に問題はなかったですが、たくさんのLambdaを組み合わせて大きな実装をする際にはどのような構成にするか迷いそうだな、と感じました。

１つの関数に関連付けできるLambda-Layersは５つまでとなっており、Lambda-Layers内のパッケージは重複してもエラーになることは無いようだったので、用途に応じたパッケージの固まりをLambda-Layersにしておいて、利用するのが良いのかなと思いました。

参考

https://dev.classmethod.jp/articles/multiple-lambda-layers-have-folders-with-the-same-name/


例）
- Google Calendarを利用する関数で使うパッケージのLambda-Layers
    - Googleの認証用のパッケージ
    - Google Calendar用のパッケージ
- Google Driveを利用する関数で使うパッケージのLambda-Layers
    - Googleの認証用のパッケージ
    - Google Drive用のパッケージ

認証用のパッケージは重複するが気にしない

## コンテナを利用したLambda
今回の実装ではずんだもんに喋ってもらうため実行環境にVOICEVOXが必要でした。
通常のLambdaのランタイムではできないため、VOICEVOXをインストールしたコンテナイメージを作成し、そのイメージをLambdaで実行する形にしました。

こちらは先人がいらっしゃったため、かなりすんなり進みました。
大変助かりました！ありがとうございます！！

https://qiita.com/wanwan_fox/items/b384fe5947a6f8ead53e

ただ私の知識不足からいくつか詰まったポイントがあったので恥ずかしながら記載します。

### ECRのPublic registryとPrivate registryの違い
料金を確認したところPublic registryの方が安かったため、イメージはPublic registryに配置しようと思いました。

しかしそもそも**LambdaではPublic registryのイメージは利用できません**でした。
これを知らず、Lambdaの実装を聞いたコンテキストがある状態で、ChatGPTに「ECRへのイメージの配置方法を教えて」と聞きながら実装を進めていました。
そのためPrivate registryへの配置と判断され、なかなかうまくいきませんでした。

ただ何度かやりとりをしてPublic registryにイメージを配置したいことが伝わると、コマンドが違うことを強調して教えてくれたりして、助かりました。
思い込みもあったのですが、個人的にはコマンドが違うことにはちょっとおどろきました。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1126770/99c666e4-d936-4cd5-a8d0-6cda3684d668.png)

その後Lambdaでイメージを指定しようとしてできなかった時。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1126770/01b82a32-c25c-44ee-8f02-bfbf7ef7be04.png)

Public registryとPrivate registryの違いを学習できました。

#### Public registry
- CLIのコマンドは `aws ecr-public` 
- IAMポリシーのPrefixは `ecr-public`
- Regionは `us-east-1` のみ
- Lambdaの実行イメージとしては使えない
- 料金はほぼかからない
#### Private registry
- CLIのコマンドは `aws ecr`
- IAMポリシーのPrefixは `ecr` 
- Regionは任意のリージョンを選択できる
- Lambdaの実行イメージとして使える
- 料金はちょっとかかる（4GBのイメージで月50円ぐらい）

ちゃんとマニュアルを読みましょう。

## 初期タイムアウト設定は3秒
これはWorkShopやJAMイベントでも頻出なので、進研ゼミでやったやつだ！
という感じですが、Lambdaの初期タイムアウト時間は3秒です。
音声ファイルを扱ったりするバッチ処理的なものだとほぼタイムアウトするため伸ばす必要があります。

つづく。


追記：続きです

https://qiita.com/gengen0719/items/78039695fe1a2e6c90d3
